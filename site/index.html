<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>ALABAR ‚Äî –æ–¥–µ–∂–¥–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π</title>
  <!-- API –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω–µ: —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ kchrmarket.ru -->
  <!-- <script>window.ALABAR_API_BASE='https://api.kchrmarket.ru';</script> -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f6f6;
      --card: #fff;
      --accent: #7c3aed;
      --accent-hover: #6d28d9;
      --accent-light: rgba(124, 58, 237, 0.1);
      --accent-selected: #a78bfa;
      --accent-selected-hover: #8b5cf6;
      --text: #1a1a1a;
      --text-muted: #666;
      --border: #e5e5e5;
      --old-price: #999;
      --discount: #e11d48;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { touch-action: manipulation; -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.4;
      touch-action: manipulation;
    }
    @media (max-width: 768px) {
      body { padding-bottom: 70px; }
    }
    /* Header */
    .header {
      background: var(--accent);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      touch-action: manipulation;
    }
    .header * { touch-action: manipulation; }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-back {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.5rem;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .header-back.visible { display: flex; }
    .header-title {
      font-weight: 700;
      font-size: 1.25rem;
      color: #fff;
      margin-right: auto;
    }
    .header-actions {
      display: flex;
      gap: 8px;
    }
    .header-actions button,
    .header-actions .header-cart-link,
    .header-actions .header-orders-link {
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.1rem;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    .header-cart-link { display: none; position: relative; }
    @media (min-width: 769px) {
      .header-cart-link { display: flex; }
    }
    @media (max-width: 768px) {
      .header-cart-link { display: none !important; }
    }
    .header-cart-link .cart-num {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #fff;
      color: var(--accent);
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      font-size: 0.65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header-row-wrap { margin-top: 10px; }
    .header-search-bar {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 10px 14px;
      gap: 8px;
      font-size: 0.9rem;
    }
    .header-search-bar::before { content: 'üîç'; flex-shrink: 0; opacity: 0.7; }
    .header-search-bar input {
      flex: 1;
      border: none;
      background: none;
      outline: none;
      font-family: inherit;
      font-size: inherit;
      color: var(--text);
    }
    .header-search-bar input::placeholder { color: var(--text-muted); }
    .header-delivery-trigger {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 16px;
      min-height: 48px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      text-align: center;
    }
    .header-delivery-trigger.visible { display: flex; }
    .header-delivery-trigger:hover { background: #fff; }
    .header-search-bar.hidden { display: none !important; }
    @media (min-width: 769px) {
      .header-search-bar,
      .header-delivery-trigger {
        max-width: 440px;
        margin-left: auto;
        margin-right: auto;
      }
      .header-search-bar { padding: 12px 18px; font-size: 1rem; }
      .header-search-bar input { font-size: 1rem; }
      .header-delivery-trigger {
        padding: 16px 20px;
        min-height: 52px;
        font-size: 1rem;
      }
    }
    /* Catalog grid ‚Äî 2 columns */
    .catalog-wrap { padding: 16px; max-width: 900px; margin: 0 auto; }
    .catalog { display: none; }
    .catalog.active { display: block; }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (min-width: 769px) {
      .catalog-wrap { max-width: 1280px; }
      .grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .card-gallery {
      aspect-ratio: 3 / 4;
      position: relative;
      overflow: hidden;
    }
    .card-gallery:has(.card-dots) {
      touch-action: pan-y;
    }
    .card-gallery-track {
      display: flex;
      height: 100%;
      transition: transform 0.25s ease-out;
      will-change: transform;
    }
    .card-gallery .slide {
      flex: 0 0 calc(100% / var(--slide-count, 1));
      width: calc(100% / var(--slide-count, 1));
      min-width: 0;
      height: 100%;
      overflow: hidden;
      position: relative;
    }
    .card-gallery .slide-inner {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }
    .card-gallery .slide-inner img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      pointer-events: none;
    }
    .card-dots {
      position: absolute;
      bottom: 8px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      z-index: 2;
    }
    .card-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      border: none;
      padding: 0;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .card-dot:hover { background: rgba(255,255,255,0.9); }
    .card-dot.active { background: #fff; transform: scale(1.2); }
    .card-badges {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      pointer-events: none;
    }
    .card-badge {
      background: rgba(255,255,255,0.95);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
    }
    .card-actions button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-body { padding: 10px; }
    .card-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; line-height: 1.3; }
    .card-brand { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
    .card-desc { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; }
    .card-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }
    .card-rating .stars { color: #f59e0b; }
    .card-rating .count { color: var(--text-muted); }
    .card-prices {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .card-price-old { font-size: 0.8rem; color: var(--old-price); text-decoration: line-through; }
    .card-price { font-weight: 700; font-size: 1rem; color: var(--text); }
    .card-discount {
      background: var(--discount);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .card-add {
      width: 100%;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .card-add:hover { background: var(--accent-hover); }
    .card-qty {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      background: var(--accent-selected);
      border-radius: 10px;
      overflow: hidden;
    }
    .card-qty-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-qty-btn:hover { background: var(--accent-selected-hover); }
    .card-qty-num {
      min-width: 36px;
      text-align: center;
      font-weight: 600;
      font-size: 0.95rem;
      color: #fff;
    }
    /* Cart screen */
    .cart-screen { display: none; padding: 16px; max-width: 600px; margin: 0 auto; }
    .cart-screen.active { display: block; }
    .back-link {
      color: var(--accent);
      text-decoration: none;
      margin-bottom: 16px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }
    .back-link:hover { text-decoration: underline; }
    .cart-screen h1 { margin-bottom: 16px; font-size: 1.5rem; }
    .cart-items { margin-bottom: 20px; }
    .cart-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--card);
      border-radius: 12px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      align-items: center;
      cursor: pointer;
    }
    .cart-item img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart-item-info { flex: 1; min-width: 0; }
    .cart-item-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
    .cart-item-price { color: var(--accent); font-size: 0.95rem; font-weight: 600; }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cart-item-qty button {
      width: 28px;
      height: 28px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .cart-item-qty button:hover { background: var(--bg); }
    .cart-item-qty span { min-width: 22px; text-align: center; font-weight: 600; }
    .cart-item-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 1.25rem;
    }
    .cart-item-remove:hover { color: #e11d48; }
    .cart-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--card);
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.25s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h2 { font-size: 1.1rem; }
    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .modal-tab {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: transparent;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
    }
    .modal-tab:hover { border-color: var(--text-muted); }
    .modal-tab.active { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .modal-panel { display: none; }
    .modal-panel.active { display: block; }
    .pvz-list { list-style: none; }
    .pvz-item {
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .pvz-item:hover { border-color: var(--accent); background: var(--accent-light); }
    .pvz-item.selected { border-color: var(--accent); background: var(--accent-light); }
    .pvz-item strong { display: block; margin-bottom: 4px; }
    .pvz-item span { color: var(--text-muted); font-size: 0.85rem; }
    .pvz-item-nearest { position: relative; }
    .pvz-nearest-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent);
      background: var(--accent-light);
      padding: 2px 8px;
      border-radius: 6px;
    }
    .address-block label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
    .address-block textarea {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
      min-height: 100px;
      resize: vertical;
    }
    .address-block textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    .modal-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
    }
    .modal-btn:hover { background: var(--accent-hover); }
    .order-total {
      background: var(--card);
      border-radius: 12px;
      padding: 16px 20px;
      border: 1px solid var(--border);
    }
    .order-total .row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .order-total .total { font-size: 1.2rem; font-weight: 700; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
    .btn-order {
      width: 100%;
      margin-top: 12px;
      padding: 14px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
    }
    .btn-order:hover { background: var(--accent-hover); }
    .btn-order:disabled { opacity: 0.5; cursor: not-allowed; }
    /* Bottom nav ‚Äî —Ç–æ–ª—å–∫–æ –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 8px 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-around;
      z-index: 90;
    }
    @media (min-width: 769px) {
      .bottom-nav { display: none; }
      body { padding-bottom: 0; }
    }
    .bottom-nav a, .bottom-nav button {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.7rem;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
    }
    .bottom-nav a.active, .bottom-nav a:hover { color: var(--accent); }
    .bottom-nav .nav-icon { font-size: 1.4rem; position: relative; }
    .bottom-nav .cart-wrap { position: relative; }
    .bottom-nav .cart-count {
      position: absolute;
      top: -6px;
      right: -10px;
      background: #ef4444;
      color: #fff;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* –û–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ ‚Äî –≤—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É –¥–æ —à–∞–ø–∫–∏ */
    .product-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 210;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .product-modal-overlay.open { display: flex; }
    @media (min-width: 769px) {
      .product-modal-overlay.open { align-items: center; padding: 20px; }
    }
    .product-modal {
      background: var(--card);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      position: relative;
      animation: slideUp 0.25s ease;
    }
    @media (min-width: 769px) {
      .product-modal { border-radius: 16px; max-height: 90vh; }
    }
    .product-modal .p-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.4);
      color: #fff;
      font-size: 1.25rem;
      cursor: pointer;
      z-index: 3;
    }
    .product-modal .p-gallery {
      aspect-ratio: 1;
      position: relative;
      overflow: hidden;
      background: var(--bg);
      touch-action: pan-y;
      flex-shrink: 0;
      cursor: grab;
      user-select: none;
    }
    .product-modal .p-gallery:active { cursor: grabbing; }
    .product-modal .p-gallery-track {
      display: flex;
      height: 100%;
      transition: transform 0.25s ease;
      pointer-events: none;
    }
    .product-modal .p-gallery .p-dots { pointer-events: auto; }
    .product-modal .p-slide {
      flex: 0 0 calc(100% / var(--p-count, 1));
      width: calc(100% / var(--p-count, 1));
      min-width: 0;
    }
    .product-modal .p-slide img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    .product-modal .p-dots {
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    .product-modal .p-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .product-modal .p-dot.active { background: #fff; }
    .product-modal .p-body { padding: 16px; }
    .product-modal .p-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 8px; line-height: 1.3; }
    .product-modal .p-features {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    .product-modal .p-feat {
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .product-modal .p-prices { margin-bottom: 4px; }
    .product-modal .p-price-old { font-size: 0.85rem; color: var(--text-muted); text-decoration: line-through; margin-right: 8px; }
    .product-modal .p-price { font-weight: 700; font-size: 1.25rem; }
    .product-modal .p-marketplaces-wrap { margin-bottom: 12px; }
    .product-modal .p-marketplaces-link { font-size: 0.9rem; color: var(--accent); text-decoration: none; }
    .product-modal .p-marketplaces-link:hover { text-decoration: underline; }
    .product-modal .p-discount {
      background: var(--discount);
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    .product-modal .p-rating { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px; }
    .product-modal .p-rating .stars { color: #f59e0b; }
    .product-modal .p-size-wrap { margin-bottom: 16px; }
    .product-modal .p-size-label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .product-modal .p-size-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .product-modal .p-size-btn {
      min-width: 44px;
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      color: var(--text);
      transition: border-color 0.2s, background 0.2s;
    }
    .product-modal .p-size-btn:hover { border-color: var(--accent); background: var(--accent-light); }
    .product-modal .p-size-btn.selected { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .product-modal .p-size-btn.p-size-out { opacity: 0.6; cursor: not-allowed; }
    .product-modal .p-size-btn:disabled { cursor: not-allowed; }
    .product-modal .p-actions { display: flex; gap: 10px; }
    .product-modal .p-cart-block { flex: 1; min-width: 0; }
    .product-modal .p-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      font-family: inherit;
    }
    .product-modal .p-btn-cart {
      width: 100%;
      background: var(--accent);
      color: #fff;
    }
    .product-modal .p-btn-cart:hover { background: var(--accent-hover); }
    .product-modal .p-qty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 48px;
      background: var(--accent-selected);
      border-radius: 10px;
      overflow: hidden;
    }
    .product-modal .p-qty-btn {
      width: 48px;
      height: 100%;
      border: none;
      background: transparent;
      color: #fff;
      font-size: 1.35rem;
      font-weight: 600;
      cursor: pointer;
    }
    .product-modal .p-qty-btn:hover { background: var(--accent-selected-hover); }
    .product-modal .p-qty-num {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
    }
    .product-modal .p-btn-buy {
      background: var(--accent);
      color: #fff;
    }
    .product-modal .p-btn-buy:hover { background: var(--accent-hover); }
    /* –ü–∞–Ω–µ–ª—å ¬´–¶–µ–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö¬ª ‚Äî –≤—ã–µ–∑–∂–∞–µ—Ç —Å–Ω–∏–∑—É */
    .marketplaces-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 220;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .marketplaces-modal-overlay.open { display: flex; }
    .marketplaces-modal {
      background: var(--card);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 500px;
      padding: 20px 16px 32px;
      position: relative;
      animation: slideUp 0.25s ease;
    }
    .marketplaces-modal .m-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.4);
      color: #fff;
      font-size: 1.25rem;
      cursor: pointer;
    }
    .marketplaces-modal h3 { font-size: 1.1rem; margin-bottom: 16px; }
    .marketplaces-price-line { font-size: 1rem; margin-bottom: 20px; color: var(--text); }
    .marketplaces-price-line strong { color: var(--accent); }
    .marketplaces-links { display: flex; flex-direction: column; gap: 10px; }
    .marketplaces-links a {
      display: block;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      text-align: center;
      transition: border-color 0.2s, background 0.2s;
    }
    .marketplaces-links a:hover { border-color: var(--accent); background: var(--accent-light); }
    .marketplaces-links a.marketplaces-opt { margin-top: 4px; }
  </style>
</head>
<body>
  <header class="header" id="mainHeader">
    <div class="header-top">
      <button type="button" class="header-back" id="headerBack" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
      <span class="header-title" id="headerTitle">ALABAR</span>
      <div class="header-actions">
        <a href="zakaz.html" class="header-orders-link" aria-label="–ú–æ–∏ –∑–∞–∫–∞–∑—ã" title="–ú–æ–∏ –∑–∞–∫–∞–∑—ã">üìã</a>
        <a href="#" class="header-cart-link" id="headerCart" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">üõí<span class="cart-num" id="headerCartCount">0</span></a>
        <button type="button" id="headerSort" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ">‚áÖ</button>
      </div>
    </div>
    <div class="header-row-wrap">
      <div class="header-search-bar" id="headerSearchBar">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –≤ ALABAR" autocomplete="off">
      </div>
      <button type="button" class="header-delivery-trigger" id="headerDeliveryTrigger">–í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</button>
    </div>
  </header>
  <main>
    <section class="catalog active" id="catalog">
      <div class="catalog-wrap">
        <p class="cart-empty" id="catalogLoading" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–æ —Å–∫–ª–∞–¥–∞‚Ä¶</p>
        <div class="grid" id="catalogGrid"></div>
      </div>
    </section>
    <section class="cart-screen" id="cartScreen">
      <div class="cart-items" id="cartItems"></div>
      <div class="order-total" id="orderTotalBlock">
        <div class="row"><span>–¢–æ–≤–∞—Ä—ã</span><span id="subtotal">0 ‚ÇΩ</span></div>
        <div class="row" id="deliveryRow" style="display: none;"><span>–î–æ—Å—Ç–∞–≤–∫–∞</span><span id="deliverySum">0 ‚ÇΩ</span></div>
        <div class="row total"><span>–ò—Ç–æ–≥–æ</span><span id="total">0 ‚ÇΩ</span></div>
        <button type="button" class="btn-order" id="btnOrder" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </section>
  </main>
  <!-- Modal: –≤—ã–±–æ—Ä –ü–í–ó / –î–æ—Å—Ç–∞–≤–∫–∞ -->
  <div class="modal-overlay" id="deliveryModal">
    <div class="modal">
      <div class="modal-header">
        <h2>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h2>
        <button type="button" class="modal-close" id="closeDeliveryModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button type="button" class="modal-tab active" data-tab="pvz">–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</button>
          <button type="button" class="modal-tab" data-tab="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</button>
        </div>
        <div class="modal-panel active" id="modalPvz">
          <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 0.9rem;">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é ‚Äî –±–ª–∏–∂–∞–π—à–∏–π –ø—É–Ω–∫—Ç –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –ø–µ—Ä–≤—ã–º —Å –ø–æ–º–µ—Ç–∫–æ–π ¬´–ë–ª–∏–∂–∞–π—à–∏–π¬ª. –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏:</p>
          <ul class="pvz-list" id="pvzList"></ul>
        </div>
        <div class="modal-panel" id="modalAddress">
          <div class="address-block">
            <label for="deliveryAddress">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
            <textarea id="deliveryAddress" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn" id="applyDelivery">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>
  <!-- –û–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ -->
  <div class="product-modal-overlay" id="productModal">
    <div class="product-modal">
      <button type="button" class="p-close" id="closeProductModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <div class="p-gallery" id="productModalGallery">
        <div class="p-gallery-track" id="productModalTrack"></div>
        <div class="p-dots" id="productModalDots"></div>
      </div>
      <div class="p-body">
        <h2 class="p-title" id="productModalTitle"></h2>
        <div class="p-features" id="productModalFeatures"></div>
        <div class="p-prices">
          <span class="p-price-old" id="productModalPriceOld"></span>
          <span class="p-price" id="productModalPrice"></span>
          <span class="p-discount" id="productModalDiscount"></span>
        </div>
        <p class="p-marketplaces-wrap"><a href="#" class="p-marketplaces-link" id="productModalMarketplacesLink">–¶–µ–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö</a></p>
        <div class="p-rating" id="productModalRating"></div>
        <div class="p-size-wrap" id="productModalSizeWrap">
          <span class="p-size-label">–†–∞–∑–º–µ—Ä</span>
          <div class="p-size-list" id="productModalSizeList"></div>
        </div>
        <div class="p-actions">
          <div id="productModalCartWrap" class="p-cart-block"></div>
          <button type="button" class="p-btn p-btn-buy" id="productModalBuy">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
        </div>
      </div>
    </div>
  </div>
  <!-- –ü–∞–Ω–µ–ª—å ¬´–¶–µ–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö¬ª -->
  <div class="marketplaces-modal-overlay" id="marketplacesModal">
    <div class="marketplaces-modal">
      <button type="button" class="m-close" id="closeMarketplacesModal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <h3>–¶–µ–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö</h3>
      <p class="marketplaces-price-line" id="marketplacesPriceLine">–¢–µ–∫—É—â–∞—è —Ä–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è: <strong id="marketplacesPriceValue">0 ‚ÇΩ</strong></p>
      <div class="marketplaces-links">
        <a href="https://www.wildberries.ru/" target="_blank" rel="noopener" id="marketplacesWbLink">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Wildberries</a>
        <a href="https://www.ozon.ru/" target="_blank" rel="noopener">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Ozon</a>
        <a href="https://t.me/+79386527888" target="_blank" rel="noopener" class="marketplaces-opt">–û–±—Å—É–¥–∏—Ç—å –æ–ø—Ç</a>
      </div>
    </div>
  </div>
  <nav class="bottom-nav">
    <a href="#" class="nav-home active" id="navHome">üè†<span class="nav-icon"></span>–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="#">‚ò∞<span class="nav-icon"></span>–ö–∞—Ç–∞–ª–æ–≥</a>
    <a href="#" class="nav-cart" id="navCart">üõí<span class="cart-wrap"><span class="cart-count" id="cartCount">0</span></span>–ö–æ—Ä–∑–∏–Ω–∞</a>
    <a href="zakaz.html" class="nav-orders">üìã<span class="nav-icon"></span>–ó–∞–∫–∞–∑—ã</a>
  </nav>
  <script>
    (function() {
      var lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        var now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, { passive: false });
    })();
    // URL API: —Å –¥–æ–º–µ–Ω–∞ (https) ‚Äî —Ç–æ—Ç –∂–µ —Ö–æ—Å—Ç; —Å file:// ‚Äî localhost:8000; –∏–Ω–∞—á–µ –∑–∞–¥–∞–π—Ç–µ window.ALABAR_API_BASE
    const API_BASE = (function() {
      if (window.ALABAR_API_BASE !== undefined && window.ALABAR_API_BASE !== '') return window.ALABAR_API_BASE;
      if (window.location.protocol === 'file:' || !window.location.origin || window.location.origin === 'null')
        return 'http://127.0.0.1:8000';
      return '';
    })();

    let PRODUCTS = [];

    async function loadProductsFromApi() {
      var loadingEl = document.getElementById('catalogLoading');
      if (loadingEl) loadingEl.style.display = 'block';
      try {
        const url = API_BASE + (API_BASE.endsWith('/') ? '' : '/') + 'api/public/items/';
        const res = await fetch(url);
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞');
        const data = await res.json();
        PRODUCTS = data.map(function(item) {
          var sizes = (item.sizes || []).map(function(s) {
            return { size_label: s.size_label, quantity: s.quantity || 0 };
          });
          var images = item.photo ? [item.photo] : [];
          return {
            id: item.id,
            title: item.name,
            item_description: item.item_description || '',
            price: 0,
            priceOld: null,
            discount: 0,
            rating: 4.8,
            reviews: 0,
            images: images,
            wbUrl: '',
            sizes: sizes
          };
        });
      } catch (e) {
        console.warn('–ö–∞—Ç–∞–ª–æ–≥ —Å API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫:', e);
        PRODUCTS = [];
      }
      if (loadingEl) loadingEl.style.display = 'none';
    }

    function getSizeQuantity(product, sizeLabel) {
      if (!product.sizes) return 0;
      var s = product.sizes.find(function(x) { return String(x.size_label) === String(sizeLabel); });
      return s ? (s.quantity || 0) : 0;
    }

    function getProductSizesList(product) {
      if (!product.sizes || !product.sizes.length) return [];
      return product.sizes.slice().sort(function(a, b) {
        var na = Number(a.size_label);
        var nb = Number(b.size_label);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        return String(a.size_label).localeCompare(String(b.size_label));
      });
    }

    const PVZ_LIST = [
      { id: 'pvz1', city: '–ö–∞—Ä–∞—á–∞–µ–≤—Å–∫', address: '—É–ª. –õ–µ–Ω–∏–Ω–∞, 42', deliveryPrice: 99 },
      { id: 'pvz2', city: '–ß–µ—Ä–∫–µ—Å—Å–∫', address: '–ø—Ä. –ú–∏—Ä–∞, 15', deliveryPrice: 99 },
      { id: 'pvz3', city: '–£—á–∫–µ–∫–µ–Ω', address: '–û–∑–æ–Ω, —É–ª. 20-–≥–æ –ü–∞—Ä—Ç—Å—ä–µ–∑–¥–∞, 8', deliveryPrice: 49, lat: 43.9432445, lng: 42.5139334 },
      { id: 'pvz4', city: '–£—á–∫–µ–∫–µ–Ω', address: 'Wildberries, –ø–µ—Ä. –ü–µ—Ä–≤–æ–º–∞–π—Å–∫–∏–π, 34', deliveryPrice: 49, lat: 43.942761, lng: 42.509699 }
    ];
    const DELIVERY_ADDRESS_PRICE = 149;

    let cart = [];
    let deliveryMode = 'pvz';
    let catalogSortOrder = null;
    let selectedPvzId = null;

    function saveCart() {
      localStorage.setItem('alabar_cart', JSON.stringify(cart));
      updateCartCount();
    }

    function loadCart() {
      try {
        const s = localStorage.getItem('alabar_cart');
        if (s) cart = JSON.parse(s);
      } catch (_) {}
      updateCartCount();
    }

    function updateCartCount() {
      const n = cart.reduce((sum, i) => sum + (i.qty || 1), 0);
      const el = document.getElementById('cartCount');
      const headerEl = document.getElementById('headerCartCount');
      if (el) el.textContent = n;
      if (headerEl) headerEl.textContent = n;
    }

    function getProduct(id) {
      return PRODUCTS.find(p => p.id === id);
    }

    function getCartQty(productId) {
      const item = cart.find(i => i.id === productId);
      return item ? (item.qty || 1) : 0;
    }

    function addToCart(productId, size) {
      const p = getProduct(productId);
      if (!p) return;
      const sizesList = getProductSizesList(p);
      const firstSize = sizesList[0] ? sizesList[0].size_label : null;
      const existing = cart.find(i => i.id === productId);
      const sizeToUse = size != null ? size : (existing && existing.size != null ? existing.size : firstSize);
      const available = getSizeQuantity(p, sizeToUse);
      if (available <= 0) return;
      if (existing) {
        const newQty = (existing.qty || 1) + 1;
        existing.qty = Math.min(newQty, getSizeQuantity(p, sizeToUse));
        existing.size = sizeToUse;
      } else {
        cart.push({ id: productId, qty: 1, size: sizeToUse });
      }
      saveCart();
      renderCatalog();
    }

    function setQty(productId, delta) {
      const item = cart.find(i => i.id === productId);
      if (!item) return;
      const p = getProduct(productId);
      const maxQty = p ? getSizeQuantity(p, item.size) : 999;
      const newQty = (item.qty || 1) + delta;
      if (newQty <= 0) {
        cart = cart.filter(i => i.id !== productId);
      } else {
        item.qty = Math.min(newQty, maxQty);
      }
      saveCart();
      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(i => i.id !== productId);
      saveCart();
      renderCart();
    }

    function getDeliveryCost() {
      if (deliveryMode === 'pvz' && selectedPvzId) {
        const pvz = PVZ_LIST.find(p => p.id === selectedPvzId);
        return pvz ? pvz.deliveryPrice : 0;
      }
      if (deliveryMode === 'delivery' && (document.getElementById('deliveryAddress').value || '').trim()) {
        return DELIVERY_ADDRESS_PRICE;
      }
      return 0;
    }

    function updateOrderTotalBlock(subtotal, deliveryCost) {
      const row = document.getElementById('deliveryRow');
      const sumEl = document.getElementById('deliverySum');
      const totalEl = document.getElementById('total');
      if (!totalEl) return;
      if (deliveryCost > 0 && row && sumEl) {
        row.style.display = 'flex';
        sumEl.textContent = deliveryCost.toLocaleString('ru-RU') + ' ‚ÇΩ';
      } else if (row) {
        row.style.display = 'none';
      }
      totalEl.textContent = (subtotal + deliveryCost).toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    function updateDeliverySummary() {
      const headerBtn = document.getElementById('headerDeliveryTrigger');
      if (!headerBtn) return;
      const hasSelection = (deliveryMode === 'pvz' && selectedPvzId) ||
        (deliveryMode === 'delivery' && (document.getElementById('deliveryAddress').value || '').trim());
      if (deliveryMode === 'pvz' && selectedPvzId) {
        const pvz = PVZ_LIST.find(p => p.id === selectedPvzId);
        headerBtn.textContent = pvz ? `${pvz.city}, ${pvz.address} ¬∑ ${pvz.deliveryPrice} ‚ÇΩ` : '–í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è';
      } else if (deliveryMode === 'delivery' && hasSelection) {
        headerBtn.textContent = document.getElementById('deliveryAddress').value.trim() + ` ¬∑ ${DELIVERY_ADDRESS_PRICE} ‚ÇΩ`;
      } else {
        headerBtn.textContent = '–í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è';
      }
      if (cart.length) {
        const subtotal = cart.reduce((s, i) => {
          const p = getProduct(i.id);
          return s + (p ? p.price * (i.qty || 1) : 0);
        }, 0);
        updateOrderTotalBlock(subtotal, getDeliveryCost());
      }
      updateOrderButton();
    }

    function renderCatalog() {
      const grid = document.getElementById('catalogGrid');
      const query = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      let list = query
        ? PRODUCTS.filter(p => p.title.toLowerCase().includes(query))
        : [...PRODUCTS];
      if (catalogSortOrder === 'asc') list.sort((a, b) => a.price - b.price);
      else if (catalogSortOrder === 'desc') list = [...list].sort((a, b) => b.price - a.price);
      grid.innerHTML = list.map(p => {
        const uniqueImages = [...new Set(p.images || [])];
        const hasMultiplePhotos = uniqueImages.length > 1;
        const slidesHtml = uniqueImages.length
          ? uniqueImages.map((src, i) =>
              '<div class="slide" data-index="' + i + '"><div class="slide-inner"><img src="' + src + '" alt="' + (p.title || '').replace(/"/g, '&quot;') + '"></div></div>'
            ).join('')
          : '<div class="slide" data-index="0"><div class="slide-inner"><img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'/%3E" alt=""></div></div>';
        const dotsHtml = hasMultiplePhotos
          ? uniqueImages.map((_, i) => `<button type="button" class="card-dot ${i === 0 ? 'active' : ''}" data-index="${i}" aria-label="–§–æ—Ç–æ ${i + 1}"></button>`).join('')
          : '';
        const qty = getCartQty(p.id);
        const totalStock = (p.sizes || []).reduce(function(sum, s) { return sum + (s.quantity || 0); }, 0);
        const inStock = totalStock > 0;
        const stockText = totalStock > 0 ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
        const addBlock = qty > 0
          ? `<div class="card-qty"><button type="button" class="card-qty-btn" data-id="${p.id}" data-delta="-1" aria-label="–ú–µ–Ω—å—à–µ">‚àí</button><span class="card-qty-num">${qty}</span><button type="button" class="card-qty-btn" data-id="${p.id}" data-delta="1" aria-label="–ë–æ–ª—å—à–µ">+</button></div>`
          : (inStock ? `<button type="button" class="card-add" data-add="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>` : '<span class="card-add" style="opacity:0.7;cursor:default">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>');
        const priceBlock = p.price > 0
          ? `<span class="card-price-old">${(p.priceOld || p.price).toLocaleString('ru-RU')} ‚ÇΩ</span><span class="card-price">${p.price.toLocaleString('ru-RU')} ‚ÇΩ</span><span class="card-discount">‚àí${p.discount || 0}%</span>`
          : `<span class="card-price">–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É</span><span class="card-price-old" style="display:none"></span><span class="card-discount" style="display:none"></span>`;
        return `
          <article class="card" data-product-id="${p.id}">
            <div class="card-gallery" data-gallery>
              <div class="card-badges"><span class="card-badge">100% —Ö–ª–æ–ø–æ–∫</span></div>
              <div class="card-actions">
                <button type="button" aria-label="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">‚ô°</button>
              </div>
              <div class="card-gallery-track" style="width: ${(uniqueImages.length || 1) * 100}%; --slide-count: ${uniqueImages.length || 1}">${slidesHtml}</div>
              ${dotsHtml ? `<div class="card-dots">${dotsHtml}</div>` : ''}
            </div>
            <div class="card-body">
              <div class="card-title">${p.title}</div>
              <div class="card-brand">${stockText}</div>
              <div class="card-desc">${(p.item_description || '').substring(0, 50) || '–¢–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞'}${(p.item_description || '').length > 50 ? '...' : ''}</div>
              <div class="card-rating" style="${(p.reviews || 0) ? '' : 'display:none'}"><span class="stars">‚òÖ ${p.rating || 4.8}</span> <span class="count">${(p.reviews || 0).toLocaleString('ru-RU')} –æ—Ü–µ–Ω–æ–∫</span></div>
              <div class="card-prices">${priceBlock}</div>
              ${addBlock}
            </div>
          </article>`;
      }).join('');

      if (list.length === 0) {
        grid.innerHTML = '<p class="cart-empty" style="grid-column: 1/-1;">–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      }

      grid.addEventListener('click', (e) => {
        if (e.target.closest('.card-add') || e.target.closest('.card-qty')) return;
        const card = e.target.closest('.card[data-product-id]');
        if (card) openProductModal(card.dataset.productId);
      });

      grid.querySelectorAll('.card-add[data-add]').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); addToCart(btn.dataset.add); });
      });
      grid.querySelectorAll('.card-qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          setQty(btn.dataset.id, parseInt(btn.dataset.delta, 10));
          renderCatalog();
        });
      });

      grid.querySelectorAll('[data-gallery]').forEach(gallery => {
        const track = gallery.querySelector('.card-gallery-track');
        const slides = gallery.querySelectorAll('.slide');
        const dots = gallery.querySelectorAll('.card-dot');
        const total = slides.length;

        if (total <= 1) return;

        let current = 0;
        let touchStartX = 0;
        let touchCurrentX = 0;

        function goTo(idx) {
          current = (idx + total) % total;
          track.style.transition = 'transform 0.25s ease-out';
          track.style.transform = `translateX(-${current * (100 / total)}%)`;
          dots.forEach((d, i) => d.classList.toggle('active', i === current));
        }

        dots.forEach((dot, i) => {
          dot.addEventListener('click', (e) => { e.stopPropagation(); goTo(i); });
        });

        gallery.addEventListener('touchstart', (e) => {
          touchStartX = touchCurrentX = e.touches[0].clientX;
        }, { passive: true });
        gallery.addEventListener('touchmove', (e) => {
          touchCurrentX = e.touches[0].clientX;
        }, { passive: true });
        gallery.addEventListener('touchend', (e) => {
          const dX = touchStartX - touchCurrentX;
          if (Math.abs(dX) > 40) goTo(dX > 0 ? current + 1 : current - 1);
        }, { passive: true });

        gallery.addEventListener('mousedown', (e) => {
          if (e.button !== 0) return;
          touchStartX = e.clientX;
          const onMouseMove = (e2) => { touchCurrentX = e2.clientX; };
          const onMouseUp = () => {
            const dX = touchStartX - touchCurrentX;
            if (Math.abs(dX) > 40) goTo(dX > 0 ? current + 1 : current - 1);
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          };
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      const totalBlock = document.getElementById('orderTotalBlock');
      if (!cart.length) {
        container.innerHTML = '<p class="cart-empty">–í –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</p>';
        totalBlock.style.display = 'none';
        updateDeliverySummary();
        return;
      }
      totalBlock.style.display = 'block';
      let subtotal = 0;
      container.innerHTML = cart.map(item => {
        const p = getProduct(item.id);
        if (!p) return '';
        const qty = item.qty || 1;
        subtotal += p.price * qty;
        const sizeStr = item.size != null ? ` ¬∑ ${item.size}` : '';
        const imgSrc = (p.images && p.images[0]) ? p.images[0] : '';
        return `
          <div class="cart-item" data-product-id="${p.id}">
            <img src="${imgSrc}" alt="${p.title}" onerror="this.style.display='none'">
            <div class="cart-item-info">
              <div class="cart-item-title">${p.title}${sizeStr}</div>
              <div class="cart-item-price">${(p.price * qty).toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
            <div class="cart-item-qty">
              <button type="button" data-id="${p.id}" data-delta="-1">‚àí</button>
              <span>${qty}</span>
              <button type="button" data-id="${p.id}" data-delta="1">+</button>
            </div>
            <button type="button" class="cart-item-remove" data-remove="${p.id}" aria-label="–£–¥–∞–ª–∏—Ç—å">√ó</button>
          </div>`;
      }).join('');

      document.getElementById('subtotal').textContent = subtotal.toLocaleString('ru-RU') + ' ‚ÇΩ';
      const deliveryCost = getDeliveryCost();
      updateOrderTotalBlock(subtotal, deliveryCost);

      container.addEventListener('click', (e) => {
        const item = e.target.closest('.cart-item[data-product-id]');
        if (!item) return;
        if (e.target.closest('.cart-item-qty') || e.target.closest('.cart-item-remove')) return;
        openProductModal(item.dataset.productId);
      });
      container.querySelectorAll('[data-delta]').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); setQty(btn.dataset.id, parseInt(btn.dataset.delta, 10)); });
      });
      container.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); removeFromCart(btn.dataset.remove); });
      });

      updateDeliverySummary();
      updateOrderButton();
    }

    function haversineKm(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function renderPvzInModal(userLat, userLng) {
      const list = document.getElementById('pvzList');
      if (!list) return;
      let ordered = [...PVZ_LIST];
      let nearestId = null;
      if (userLat != null && userLng != null) {
        const withCoords = PVZ_LIST.filter(p => p.lat != null && p.lng != null);
        const withoutCoords = PVZ_LIST.filter(p => p.lat == null || p.lng == null);
        if (withCoords.length) {
          withCoords.sort((a, b) => haversineKm(userLat, userLng, a.lat, a.lng) - haversineKm(userLat, userLng, b.lat, b.lng));
          nearestId = withCoords[0].id;
          ordered = [...withCoords, ...withoutCoords];
        }
      }
      list.innerHTML = ordered.map(pvz => `
        <li class="pvz-item ${pvz.id === nearestId ? 'pvz-item-nearest' : ''}" data-pvz-id="${pvz.id}">
          ${pvz.id === nearestId ? '<span class="pvz-nearest-badge">–ë–ª–∏–∂–∞–π—à–∏–π</span>' : ''}
          <strong>${pvz.city}</strong>
          <span>${pvz.address}</span>
        </li>
      `).join('');
      list.querySelectorAll('.pvz-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.pvzId === selectedPvzId);
        el.addEventListener('click', () => {
          list.querySelectorAll('.pvz-item').forEach(i => i.classList.remove('selected'));
          el.classList.add('selected');
          selectedPvzId = el.dataset.pvzId;
          document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'pvz'));
          document.getElementById('modalPvz').classList.add('active');
          document.getElementById('modalAddress').classList.remove('active');
          deliveryMode = 'pvz';
        });
      });
    }

    function updateOrderButton() {
      const btn = document.getElementById('btnOrder');
      if (!btn) return;
      if (deliveryMode === 'pvz') {
        btn.disabled = !selectedPvzId || !cart.length;
      } else {
        const addr = (document.getElementById('deliveryAddress').value || '').trim();
        btn.disabled = !addr || !cart.length;
      }
    }

    function openDeliveryModal() {
      document.getElementById('deliveryModal').classList.add('open');
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === deliveryMode));
      document.getElementById('modalPvz').classList.toggle('active', deliveryMode === 'pvz');
      document.getElementById('modalAddress').classList.toggle('active', deliveryMode === 'delivery');
      if (deliveryMode === 'delivery') {
        document.getElementById('deliveryAddress').focus();
      }
      renderPvzInModal();
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          renderPvzInModal(pos.coords.latitude, pos.coords.longitude);
        },
        () => {},
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
      );
    }

    function closeDeliveryModal() {
      document.getElementById('deliveryModal').classList.remove('open');
      updateDeliverySummary();
    }

    let productModalProductId = null;
    let productModalSlideIndex = 0;
    let productModalSelectedSize = 56;

    function openProductModal(productId) {
      const p = getProduct(productId);
      if (!p) return;
      productModalProductId = productId;
      const sizesList = getProductSizesList(p);
      const cartItem = cart.find(i => i.id === productId);
      const firstSizeLabel = sizesList[0] ? sizesList[0].size_label : null;
      const hasCartSize = cartItem && sizesList.some(function(s) { return String(s.size_label) === String(cartItem.size); });
      productModalSelectedSize = (cartItem && hasCartSize) ? cartItem.size : firstSizeLabel;
      const imgs = [...new Set(p.images || [])];
      const track = document.getElementById('productModalTrack');
      const dotsWrap = document.getElementById('productModalDots');
      track.style.width = (imgs.length || 1) * 100 + '%';
      track.style.setProperty('--p-count', imgs.length || 1);
      track.innerHTML = (imgs.length ? imgs : ['']).map(src => src ? `<div class="p-slide"><img src="${src}" alt="${p.title}"></div>` : '<div class="p-slide"><img src="data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'/%3E" alt=""></div>').join('');
      dotsWrap.innerHTML = imgs.length > 1
        ? imgs.map((_, i) => `<button type="button" class="p-dot ${i === 0 ? 'active' : ''}" data-idx="${i}"></button>`).join('')
        : '';
      productModalSlideIndex = 0;
      document.getElementById('productModalTitle').textContent = p.title;
      document.getElementById('productModalFeatures').innerHTML = (p.item_description ? '<span class="p-feat">' + (p.item_description.substring(0, 80) + (p.item_description.length > 80 ? '‚Ä¶' : '')) + '</span>' : '');
      if (p.price > 0) {
        document.getElementById('productModalPriceOld').textContent = (p.priceOld || p.price).toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('productModalPrice').textContent = p.price.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('productModalDiscount').textContent = '‚àí' + (p.discount || 0) + '%';
        document.getElementById('productModalPriceOld').style.display = '';
        document.getElementById('productModalDiscount').style.display = '';
      } else {
        document.getElementById('productModalPrice').textContent = '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';
        document.getElementById('productModalPriceOld').style.display = 'none';
        document.getElementById('productModalDiscount').style.display = 'none';
      }
      document.getElementById('productModalRating').innerHTML = (p.reviews || 0) ? `<span class="stars">‚òÖ ${p.rating || 4.8}</span> ${(p.reviews || 0).toLocaleString('ru-RU')} –æ—Ü–µ–Ω–æ–∫` : '';
      const sizeList = document.getElementById('productModalSizeList');
      const sizeWrap = document.getElementById('productModalSizeWrap');
      if (sizesList.length === 0) {
        sizeWrap.style.display = 'none';
      } else {
        sizeWrap.style.display = '';
        sizeList.innerHTML = sizesList.map(function(s) {
          var label = s.size_label;
          var qty = s.quantity || 0;
          var inStock = qty > 0;
          var labelText = inStock ? label + ' ‚Äî ' + qty + ' —à—Ç.' : label + ' ‚Äî –Ω–µ—Ç';
          var cls = 'p-size-btn' + (String(label) === String(productModalSelectedSize) ? ' selected' : '') + (inStock ? '' : ' p-size-out');
          return '<button type="button" class="' + cls + '" data-size="' + String(label).replace(/"/g, '&quot;') + '" ' + (inStock ? '' : 'disabled') + '>' + labelText + '</button>';
        }).join('');
        sizeList.querySelectorAll('.p-size-btn').forEach(btn => {
          if (btn.disabled) return;
          btn.addEventListener('click', () => {
            productModalSelectedSize = btn.dataset.size;
            sizeList.querySelectorAll('.p-size-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            updateProductModalCartButton();
          });
        });
      }
      updateProductModalCartButton();
      document.getElementById('productModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      dotsWrap.querySelectorAll('.p-dot').forEach((dot, i) => {
        dot.addEventListener('click', () => { goToProductSlide(i); });
      });
    }

    function goToProductSlide(idx) {
      const p = getProduct(productModalProductId);
      if (!p) return;
      const imgs = [...new Set(p.images)];
      if (idx < 0 || idx >= imgs.length) return;
      productModalSlideIndex = idx;
      const track = document.getElementById('productModalTrack');
      track.style.transform = `translateX(-${idx * (100 / imgs.length)}%)`;
      document.querySelectorAll('#productModalDots .p-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
    }

    function updateProductModalCartButton() {
      const wrap = document.getElementById('productModalCartWrap');
      if (!wrap || !productModalProductId) return;
      const p = getProduct(productModalProductId);
      const available = p ? getSizeQuantity(p, productModalSelectedSize) : 0;
      const qty = getCartQty(productModalProductId);
      const id = productModalProductId;
      if (qty > 0) {
        var maxQty = p ? getSizeQuantity(p, productModalSelectedSize) : 999;
        wrap.innerHTML = '<div class="p-qty"><button type="button" class="p-qty-btn" data-delta="-1" aria-label="–ú–µ–Ω—å—à–µ">‚àí</button><span class="p-qty-num">' + qty + '</span><button type="button" class="p-qty-btn" data-delta="1" aria-label="–ë–æ–ª—å—à–µ">+</button></div>';
        wrap.querySelectorAll('.p-qty-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            setQty(id, parseInt(btn.dataset.delta, 10));
            updateProductModalCartButton();
            renderCatalog();
          });
        });
        wrap.querySelector('[data-delta="1"]').disabled = qty >= maxQty;
      } else {
        if (available > 0) {
          wrap.innerHTML = '<button type="button" class="p-btn p-btn-cart" id="productModalCartAdd">–í –∫–æ—Ä–∑–∏–Ω—É</button>';
          wrap.querySelector('.p-btn-cart').addEventListener('click', () => {
            addToCart(id, productModalSelectedSize);
            updateProductModalCartButton();
            renderCatalog();
          });
        } else {
          wrap.innerHTML = '<span class="p-btn p-btn-cart" style="opacity:0.7;cursor:default">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>';
        }
      }
    }

    function closeProductModal() {
      closeMarketplacesModal();
      document.getElementById('productModal').classList.remove('open');
      document.body.style.overflow = '';
      productModalProductId = null;
    }

    function showScreen(name) {
      document.getElementById('catalog').classList.toggle('active', name === 'catalog');
      document.getElementById('cartScreen').classList.toggle('active', name === 'cart');
      document.getElementById('headerTitle').textContent = name === 'cart' ? '–ö–æ—Ä–∑–∏–Ω–∞' : 'ALABAR';
      document.getElementById('headerBack').classList.toggle('visible', name === 'cart');
      document.getElementById('headerSearchBar').classList.toggle('hidden', name === 'cart');
      document.getElementById('headerDeliveryTrigger').classList.toggle('visible', name === 'cart');
      document.querySelector('.nav-home').classList.toggle('active', name === 'catalog');
      document.querySelector('.nav-cart').classList.toggle('active', name === 'cart');
      if (name === 'cart') {
        renderCart();
        updateDeliverySummary();
      } else {
        renderCatalog();
      }
    }

    document.getElementById('navCart').addEventListener('click', (e) => { e.preventDefault(); showScreen('cart'); });
    document.getElementById('headerCart').addEventListener('click', (e) => { e.preventDefault(); showScreen('cart'); });
    document.getElementById('navHome').addEventListener('click', (e) => { e.preventDefault(); showScreen('catalog'); });
    document.getElementById('headerBack').addEventListener('click', () => showScreen('catalog'));
    document.getElementById('headerSort').addEventListener('click', () => {
      catalogSortOrder = catalogSortOrder === 'asc' ? 'desc' : 'asc';
      renderCatalog();
    });
    document.getElementById('searchInput').addEventListener('input', () => renderCatalog());
    document.getElementById('headerDeliveryTrigger').addEventListener('click', openDeliveryModal);
    document.getElementById('closeDeliveryModal').addEventListener('click', closeDeliveryModal);
    document.getElementById('deliveryModal').addEventListener('click', (e) => {
      if (e.target.id === 'deliveryModal') closeDeliveryModal();
    });
    document.getElementById('applyDelivery').addEventListener('click', closeDeliveryModal);

    (function initProductModalGallerySwipe() {
      let touchStartX = 0, touchCurrentX = 0;
      const gallery = document.getElementById('productModalGallery');
      if (!gallery) return;
      gallery.addEventListener('touchstart', (e) => {
        touchStartX = touchCurrentX = e.touches[0].clientX;
      }, { passive: true });
      gallery.addEventListener('touchmove', (e) => {
        touchCurrentX = e.touches[0].clientX;
      }, { passive: true });
      gallery.addEventListener('touchend', (e) => {
        const dX = touchStartX - touchCurrentX;
        if (Math.abs(dX) > 40) {
          const p = getProduct(productModalProductId);
          const imgs = p && p.images ? [...new Set(p.images)] : [];
          if (imgs.length > 1) {
            const next = productModalSlideIndex + (dX > 0 ? 1 : -1);
            goToProductSlide(Math.max(0, Math.min(imgs.length - 1, next)));
          }
        }
      }, { passive: true });
      gallery.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        e.preventDefault();
        touchStartX = e.clientX;
        touchCurrentX = touchStartX;
        const onMouseMove = (e2) => { touchCurrentX = e2.clientX; };
        const onMouseUp = () => {
          const dX = touchStartX - touchCurrentX;
          if (Math.abs(dX) > 40) {
            const p = getProduct(productModalProductId);
            const imgs = p && p.images ? [...new Set(p.images)] : [];
            if (imgs.length > 1) {
              const next = productModalSlideIndex + (dX > 0 ? 1 : -1);
              goToProductSlide(Math.max(0, Math.min(imgs.length - 1, next)));
            }
          }
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp, { once: true });
      });
    })();

    function openMarketplacesModal() {
      const p = getProduct(productModalProductId);
      if (!p) return;
      document.getElementById('marketplacesPriceValue').textContent = p.price.toLocaleString('ru-RU') + ' ‚ÇΩ';
      const wbLink = document.getElementById('marketplacesWbLink');
      wbLink.href = (p.wbUrl || 'https://www.wildberries.ru/');
      document.getElementById('marketplacesModal').classList.add('open');
    }
    function closeMarketplacesModal() {
      document.getElementById('marketplacesModal').classList.remove('open');
    }

    document.getElementById('productModalMarketplacesLink').addEventListener('click', (e) => {
      e.preventDefault();
      openMarketplacesModal();
    });
    document.getElementById('closeProductModal').addEventListener('click', closeProductModal);
    document.getElementById('productModal').addEventListener('click', (e) => {
      if (e.target.id === 'productModal') closeProductModal();
    });
    document.getElementById('closeMarketplacesModal').addEventListener('click', closeMarketplacesModal);
    document.getElementById('marketplacesModal').addEventListener('click', (e) => {
      if (e.target.id === 'marketplacesModal') closeMarketplacesModal();
    });
    document.getElementById('productModalBuy').addEventListener('click', () => {
      if (productModalProductId) {
        addToCart(productModalProductId, productModalSelectedSize);
        closeProductModal();
        showScreen('cart');
      }
    });

    document.querySelectorAll('.modal-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        deliveryMode = tabName;
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
        document.getElementById('modalPvz').classList.toggle('active', tabName === 'pvz');
        document.getElementById('modalAddress').classList.toggle('active', tabName === 'delivery');
        if (tabName === 'delivery') document.getElementById('deliveryAddress').focus();
      });
    });

    document.getElementById('deliveryAddress').addEventListener('input', () => {
      updateDeliverySummary();
      updateOrderButton();
    });

    document.getElementById('btnOrder').addEventListener('click', () => {
      if (deliveryMode === 'pvz' && !selectedPvzId) return;
      if (deliveryMode === 'delivery' && !(document.getElementById('deliveryAddress').value || '').trim()) return;
      const pvz = PVZ_LIST.find(p => p.id === selectedPvzId);
      let subtotal = 0;
      const orderItems = cart.map(item => {
        const p = getProduct(item.id);
        if (!p) return null;
        const qty = item.qty || 1;
        subtotal += p.price * qty;
        return { id: p.id, title: p.title, price: p.price, qty, size: item.size, image: p.images[0] };
      }).filter(Boolean);
      const deliveryCost = getDeliveryCost();
      const order = {
        id: 'o' + Date.now(),
        date: new Date().toISOString(),
        items: orderItems,
        deliveryMode,
        deliveryInfo: deliveryMode === 'pvz'
          ? { city: pvz.city, address: pvz.address, deliveryPrice: pvz.deliveryPrice }
          : { address: document.getElementById('deliveryAddress').value.trim(), deliveryPrice: DELIVERY_ADDRESS_PRICE },
        subtotal,
        deliveryCost,
        total: subtotal + deliveryCost
      };
      try {
        const raw = localStorage.getItem('alabar_orders');
        const orders = raw ? JSON.parse(raw) : [];
        orders.unshift(order);
        localStorage.setItem('alabar_orders', JSON.stringify(orders));
      } catch (_) {}
      const msg = deliveryMode === 'pvz'
        ? `–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏: ${pvz.city}, ${pvz.address}. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑—ã –º–æ–∂–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ó–∞–∫–∞–∑—ã¬ª.`
        : `–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω. –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –∞–¥—Ä–µ—Å—É: ${document.getElementById('deliveryAddress').value.trim()}. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑—ã –º–æ–∂–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ó–∞–∫–∞–∑—ã¬ª.`;
      alert(msg);
      cart = [];
      saveCart();
      showScreen('catalog');
    });

    loadCart();
    loadProductsFromApi().then(function() {
      renderCatalog();
    });
  </script>
</body>
</html>
